<!DOCTYPE html>
<html lang=en>
<head>
<meta charset=utf-8 /> 
<meta name=viewport content="width=device-width, initial-scale=1"/>
<title>Box Line Text</title>
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<style>
html,body {
  height:100%;
  width:100%;
  z-index:0;
  overflow:hidden;
}
section,p {
  position:absolute;
  margin:0;
  padding:0;
}
section {
  border:2px solid #777;
  border-radius:10px;
}
p {
  z-index:1;
  font:32px Noto Sans CJK JP, arial;
  color:#333;
  padding:0 .5em;
  line-height:64px;
  outline:none;
}
</style>
<script>
let snap = s => Math.round(s / 64) * 64 - 2 + 'px'

function createElement(p1, p2, temporary=true, content="") {
  document.querySelectorAll('body>*:empty').forEach(e => e.remove())

  let e = document.createElement('section')
  ;[e.style.width, e.style.height] = p1.map((s, i) => snap(Math.abs(s - p2[i])))

  let text = document.createElement('p')
  text.contentEditable = 'true'
  text.textContent=content
  if (!temporary) e.append(text)

  if (!e.style.width && !e.style.height) e = text
  if (e.style.width && !e.style.height) text.style.top = '-66px'

  ;[e.style.left, e.style.top] = p1.map((s, i) => snap(Math.min(s, p2[i])))
  document.body.append(e)
  text.focus()
}

function eraseElement(target) {
  erasing = true
  if (target != document.body) target.remove()
}

function getPosition(e) {
  e = e.touches ? e.touches[0] : e
  return [e.clientX, e.clientY]
}

function mousedown(e) {
  if (e.shiftKey || e.target.tagName != 'P') {
    e.preventDefault() // Prevents content selection while dragging

    if (e.shiftKey) eraseElement(e.target)
    else dragstart = getPosition(e)
  }
}
document.addEventListener('mousedown', mousedown)
document.addEventListener('touchstart', mousedown)

function mousemove(e) {
  if (window.erasing) eraseElement(e.target)
  else if (window.dragstart) createElement(getPosition(e), dragstart)
}
document.addEventListener('mousemove', mousemove)
document.addEventListener('touchmove', mousemove)

function mouseup(e) {
  if (window.erasing || !dragstart) erasing = false
  else createElement(dragstart, getPosition(e), false)

  dragstart = false
  save()
}
document.addEventListener('mouseup', mouseup)
document.addEventListener('touchend', mouseup)

document.addEventListener('keydown', function(e) {
  if (e.ctrlKey && e.key == 'z') {
    document.querySelector('body>:last-child').remove()
    e.preventDefault() // Prevents user agent text undo
  } else if (e.key == 'Enter') {
    e.preventDefault() // Disallow hard breaks in text
  }
})

b64 = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"
posToB64 = x => b64[(parseInt(x) + 2) / 64 || 0]
b64ToPos = c => b64.indexOf(c) * 64 - 2

function save(e) {
  if (e) {
    // Grow height if the inner `p` has become taller than the box.
    if (e.target.parentNode.clientHeight && e.target.clientHeight > e.target.parentNode.clientHeight) {
      e.target.parentNode.style.height = snap(e.target.clientHeight)
    }
    // Grow width if the inner `p` has become wider than the box
    // This should only happen when individual words are wider than the box
    if (e.target.parentNode.clientWidth && e.target.clientWidth > e.target.parentNode.clientWidth) {
      e.target.parentNode.style.width = snap(e.target.clientWidth+64)
    }
  }

  location.hash = Array.from(document.querySelectorAll("body>:not(:empty)")).reduce((s,e) => {
    return s += encodeURIComponent(
      (posToB64(e.style.left) + posToB64(e.style.top) +
      posToB64(e.style.width) + posToB64(e.style.height) +
      b64[Math.floor(e.textContent.length / 64)] +
      b64[e.textContent.length % 64])
        .replace('AAA','.')
        .replace('AA', '~') +
      e.textContent).replace(/%(3F|2F|3A|40|21|24|26|27|28|29|2A|2B|2C|3B|3D)/g,c => decodeURIComponent(c)).replace(/%20/g, '+')
  }, "1")
}
document.addEventListener('keyup', save)

window.onload = () => {
  let e = decodeURIComponent(location.hash.substring(2)).replace(/\+/g,' ')

  while (e) {
    let h = ""
    let text_start = 0
    while (h.length < 6) {
      h += e[text_start].replace('.','AAA').replace('~','AA')
      text_start+=1
    }
    let text_length = b64.indexOf(h[4]) * 64 + b64.indexOf(h[5])
    createElement(
      [b64ToPos(h[0]), b64ToPos(h[1])],
      [b64ToPos(h[2]) + b64ToPos(h[0]), b64ToPos(h[3]) + b64ToPos(h[1])],
      false, e.substring(text_start,text_start+text_length))
    e = e.substring(text_length + text_start)
  }
}

document.addEventListener('paste', e => e.preventDefault())
</script>
</head>
<body>
</body>
</html>